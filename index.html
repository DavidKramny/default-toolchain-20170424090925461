<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Foosbuzz by slkaczma</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Foosbuzz</h1>
        <p>A Raspberry Pi wired Foosball table that uses the Watson IoT Foundation, Cloudant, and Node-RED</p>

        <p class="view"><a href="https://github.com/slkaczma/iot-foosball">View the Project on GitHub <small>slkaczma/iot-foosball</small></a></p>


        <ul>
          <li><a href="https://github.com/slkaczma/iot-foosball/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/slkaczma/iot-foosball/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/slkaczma/iot-foosball">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>

<p>This foosball table started out as something equivalent to a teaming project as we brought five people together in Austin, TX to retrofit an existing table with the sensors needed to track goals.  Version 2 of the code in this GitHub repo is a complete revamp and rethinking of that project to improve it's demo quality and appearance.  Feel free to let us know what you add to the app.  This is a very basic example of using Node-RED to work with an MQTT broker and a noSQL database.  </p>

<h2>
<a id="why-node-red" class="anchor" href="#why-node-red" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Why Node-RED?</h2>

<p>This table was conceived as a demo and nothing is more appealing than a visual interface.  So while there are plenty of wires and flows that could have been improved in raw code, this particular app is meant to visually guide a user through the logic as well.  Node-RED is a great wire framing platform and available on a variety of operating systems.  </p>

<h2>
<a id="technologies" class="anchor" href="#technologies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Technologies</h2>

<ul>
<li><a href="https://developer.ibm.com/iotfoundation/">Watson IoT Foundation</a></li>
<li><a href="https://cloudant.com/">Cloudant noSQL</a></li>
<li><a href="http://nodered.org/">Node-RED</a></li>
<li><a href="http://expressjs.com/">Express/Node.js</a></li>
<li><a href="http://passportjs.org/">Passport OAuth</a></li>
<li><a href="https://apps.twitter.com/">Twitter</a></li>
</ul>

<h3>
<a id="hardware-suggested-parts-and-tips-for-fitting-your-foosball-table" class="anchor" href="#hardware-suggested-parts-and-tips-for-fitting-your-foosball-table" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hardware: Suggested Parts and Tips for Fitting Your Foosball Table</h3>

<h4>
<a id="the-basics" class="anchor" href="#the-basics" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Basics</h4>

<ul>
<li>Two Sets of Break Beam Sensors (Adafruit currently has the best option out there): <a href="Adafruit">https://www.adafruit.com/products/2168</a>
</li>
<li>A Raspberry Pi 3 Kit (You need the memory card, a mountable case, a power supply, and the Pi): <a href="http://www.amazon.com/CanaKit-Raspberry-Complete-Starter-Kit/dp/B01C6Q2GSY?ie=UTF8&amp;psc=1&amp;redirect=true&amp;ref_=ox_sc_act_title_1&amp;smid=A30ZYR2W3VAJ0A">CanaKit Raspberry Pi 3</a>
</li>
<li>An arcade push button (We purchased ours from Fry's): <a href="http://www.amazon.com/Arcade-Buttons-Multicade-Choice-Colors/dp/B016ZSCOJU/ref=sr_1_3?ie=UTF8&amp;qid=1458770680&amp;sr=8-3&amp;keywords=arcade+push+button+blue">http://www.amazon.com/Arcade-Buttons-Multicade-Choice-Colors/dp/B016ZSCOJU/ref=sr_1_3?ie=UTF8&amp;qid=1458770680&amp;sr=8-3&amp;keywords=arcade+push+button+blue</a>
</li>
</ul>

<h4>
<a id="wiring" class="anchor" href="#wiring" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Wiring</h4>

<p>Now for the wiring particulars we have a few suggested routes, but do what works best with your skill set.</p>

<p>You either can splice wires with female headers or solder headers onto the wires: <a href="http://www.amazon.com/TOOGOO-Female-Solderless-Flexible-Breadboard/dp/B00HUH9GOC/ref=sr_1_1?ie=UTF8&amp;qid=1458770795&amp;sr=8-1&amp;keywords=female+to+female+wires">Female Headers</a>.  We went the splicing route.</p>

<p>You can use some cat 5/4 pair cable (ethernet cable) to splice the wires and make a common ground and power otherwise you'll need a lot of single strand copper wire.  We used four pair cable and kept a common ground and power with a separate data for each goal.  Total wiring is 5 ground, 4 power, and 3 data between the two sensors and the button.</p>

<p>If you're familiar with wiring then skip the soldering and buy some heat shrink wire <a href="http://www.elecdirect.com/butt-splice-heat-shrink-terminals-crimp-shrink-12-10ga-25pk?gclid=CjwKEAjww9O3BRDp1tq0jIP023YSJAB0-j1S1JUElzwio4ogohwFYLGEh8nma9iw-keqoVBC6fMOsRoC2vXw_wcB">butts</a>. You can also twist the wires to splice then and apply electrical tape.  Or skip straight to soldering and stop reading these instructions. </p>

<h4>
<a id="the-table" class="anchor" href="#the-table" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Table</h4>

<p>Tables differ vastly across geography.  Our table is a <a href="http://www.foosballsoccer.com/cyclone-ii.html">Tornado Cyclone II</a>.  You can use whatever table you like with the caveat that you need a large enough return chute to place the sensors where the ball will both hit and not cause a large amount of sensor damage. </p>

<h4>
<a id="watson" class="anchor" href="#watson" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Watson</h4>

<p>The application has several canned taunts as players work through the game.  This audio plays through Firefox or Chrome.  If you want the players to hear the audio then you will need a speaker for your laptop or other web enabled device.</p>

<h4>
<a id="tips-for-installing" class="anchor" href="#tips-for-installing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tips for Installing</h4>

<ul>
<li>Breadboard the sensors and button before you start installing.</li>
<li>Set the python code on the Pi to autostart at boot so you can install it and leave it.</li>
<li>If this is going to be used at a conference or other large event where lots of big cellphones are going to be clogging the air then secure a wired connection. </li>
<li>Install the break beam sensors towards the floor of the chute and slightly back from the goal to ensure the ball crosses. </li>
</ul>

<h3>
<a id="cloudant-and-starter-documents" class="anchor" href="#cloudant-and-starter-documents" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cloudant and Starter Documents</h3>

<p>The app uses an instance of Cloudant running in <a href="https://console.ng.bluemix.net/catalog/">IBM Bluemix</a>.  The application also makes use of the Cloudant nodes so if you choose to deviate from Cloudant then you will need to recode the database sections. </p>

<p>After deploying the application confirm that the players, games, and nodered databases exist.  Confirm that two documents exist in the games database with _ids of totalGames and 1. </p>

<p>Example Game Document: </p>

<pre><code>{
  "_id": "1",
  "_rev": "1-d6afc36ecfefdbb4af0b53211c1501ff",
  "userTeamOne": "Anonymous",
  "idTeamOne": null,
  "userTeamOnePhoto": null,
  "userTeamTwo": "Incognito",
  "idTeamTwo": null,
  "userTeamTwoPhoto": null,
  "goalsTeamOne": 4,
  "goalsTeamTwo": 5,
  "startTime": "Fri Mar 11 2016 17:27:35 GMT+0000 (UTC)",
  "endTime": "Fri Mar 11 2016 17:32:40 GMT+0000 (UTC)",
  "lastBall": "2016-03-11T17:32:38.912Z",
  "currentBall": "2016-03-11T17:32:40.534Z",
  "gameActive": false
}
</code></pre>

<p>Example Player Document: </p>

<pre><code>{
  "_id": "3061923715",
  "_rev": "43-49357dbbf375e47cf1e1cd7826a377d5",
  "handle": "Heres__Ollie",
  "name": "Oliver Rodriguez",
  "photo": "https://pbs.twimg.com/profile_images/573244648291885057/qXxCD2am.jpeg",
  "gamesWon": 2,
  "gamesLost": 0,
  "pointsFor": 10,
  "pointsAgainst": 6,
  "lastPlayed": "Fri Mar 11 2016 21:12:41 GMT+0000 (UTC)",
  "lastGame": "33"
}
</code></pre>

<h3>
<a id="express-server-and-node-red" class="anchor" href="#express-server-and-node-red" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Express Server and Node-RED</h3>

<p>The Express server handles a minimal amount of processing to keep all of the app logic in Node-RED.  Therefore very few changes have to be made to the code to get it running for you.</p>

<h4>
<a id="serverjs" class="anchor" href="#serverjs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>server.js</h4>

<p>Create an app with Twitter using <strong><a href="http://yourapproute.com/login/twitter/return">http://yourapproute.com/login/twitter/return</a></strong> as the callback URL, replacing yourapproute.com with the URL for the root site of your application.  After you have the consumer key and token update <strong>passport.use</strong> and <strong>client.post</strong> in server.js.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// Update the credentials with the information from your Twitter app </span>
<span class="pl-smi">passport</span>.<span class="pl-en">use</span>(<span class="pl-k">new</span> <span class="pl-en">Strategy</span>({
    consumerKey<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>TWITTER CONSUMER KEY<span class="pl-pds">"</span></span>,   <span class="pl-c">//CHANGE ME</span>
    consumerSecret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>TWITTER CONSUMER SECRET<span class="pl-pds">"</span></span>,  <span class="pl-c">//CHANGE ME</span>
    callbackURL<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>http://yourwebsite.com/login/twitter/return<span class="pl-pds">"</span></span> <span class="pl-c">//CHANGE ME</span>
  },
  <span class="pl-k">function</span>(<span class="pl-smi">token</span>, <span class="pl-smi">tokenSecret</span>, <span class="pl-smi">player</span>, <span class="pl-smi">cb</span>) {

    <span class="pl-c">// Grab the Twitter photo and strip out the minimizer  </span>
    <span class="pl-k">var</span> photo <span class="pl-k">=</span> <span class="pl-smi">player</span>.<span class="pl-smi">photos</span>[<span class="pl-c1">0</span>].<span class="pl-c1">value</span>;
    photo <span class="pl-k">=</span> <span class="pl-smi">photo</span>.<span class="pl-c1">replace</span>(<span class="pl-s"><span class="pl-pds">"</span>_normal<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>); 
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(photo);

    <span class="pl-c">// Let Node-RED know there has been a successful login and send the profile data for further processing</span>
    <span class="pl-k">var</span> args <span class="pl-k">=</span> {
       data<span class="pl-k">:</span> {id<span class="pl-k">:</span><span class="pl-smi">player</span>.<span class="pl-c1">id</span>,handle<span class="pl-k">:</span><span class="pl-smi">player</span>.<span class="pl-smi">username</span>,name<span class="pl-k">:</span><span class="pl-smi">player</span>.<span class="pl-smi">displayName</span>,photo<span class="pl-k">:</span>photo,chosenTeam<span class="pl-k">:</span>team},
       headers<span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>application/json<span class="pl-pds">"</span></span> }
    };

    <span class="pl-smi">client</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">"</span>**http://yourwebsite.com/player**<span class="pl-pds">"</span></span>, args, <span class="pl-k">function</span> (<span class="pl-smi">data</span>, <span class="pl-smi">response</span>) {  <span class="pl-c">//CHANGE ME</span>
        <span class="pl-c">//console.log(data);</span>
        <span class="pl-c">//console.log(response);</span>
    });

    <span class="pl-k">return</span> <span class="pl-en">cb</span>(<span class="pl-c1">null</span>, player);
}));</pre></div>

<h4>
<a id="defaultsflowjson" class="anchor" href="#defaultsflowjson" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>defaults/flow.json</h4>

<p>Upon deploy the app should create the flow for the foosball table, but if it doesn't, navigate to defaults/flow.json and import the JSON into Node-RED.</p>

<h4>
<a id="update-twitter-nodes" class="anchor" href="#update-twitter-nodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Update Twitter Nodes</h4>

<p>Navigate to the /red directory in a web browser and open the one light blue Twitter Out node to add your chosen Twitter account as the user.</p>

<h4>
<a id="verify-the-cloudant-nodes" class="anchor" href="#verify-the-cloudant-nodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Verify the Cloudant Nodes</h4>

<p>There are several Cloudant Nodes in flows and subflows.  They should automatically pick up the Cloudant service for your app, but make sure to open a few to confirm. </p>

<h4>
<a id="watson-iot-foundation" class="anchor" href="#watson-iot-foundation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Watson IoT Foundation</h4>

<p>The app deploys an instance of the IoT Foundation service.  You will need to run the following python code on your device and make sure it connects.  Update the blue Data from Table node with the correct credentials for your device and the service. </p>

<h4>
<a id="watson-text-to-speech" class="anchor" href="#watson-text-to-speech" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Watson Text to Speech</h4>

<p>Open the Watson Talks subflow and verify the credentials in the green Text to Speech node.  If no credentials are present then you will need to look up the credentials for your service.</p>

<p>You can access the Watson socket audio at /watson to hear taunts as players battle it out. </p>

<h3>
<a id="raspberry-pi-configuration" class="anchor" href="#raspberry-pi-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Raspberry Pi Configuration</h3>

<p>This code is very similar to Version 1 but uses breakbeam sensors instead of avoidance sensors. <a href="https://github.com/vmorris">Vance Morris</a> kindly consulted on the configuration of the Pi as well as modifications for his original code. We love you Vance!</p>

<h4>
<a id="tablepy" class="anchor" href="#tablepy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>table.py</h4>

<p>You need the ibmiotf libraries and the RPI.GPIO libraries</p>

<pre><code>sudo apt-get install python-dev python-rpi.gpio
</code></pre>

<pre><code>pip install ibmiotf 
</code></pre>

<p>table.py must reside in /home/pi/my_table for the service file to work</p>

<pre><code>sudo mkdir /home/pi/my_table
</code></pre>

<p>Update the credentials in table.py with your device credentials for the Watson IoT Foundation:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-c"># setup IoT Foundation information</span>
<span class="pl-c"># replace with your credentials</span>
org <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>ORG<span class="pl-pds">"</span></span>
<span class="pl-c1">type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>table<span class="pl-pds">"</span></span>
<span class="pl-c1">id</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>ID<span class="pl-pds">"</span></span>
method<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>
token<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>AUTH-TOKEN<span class="pl-pds">"</span></span>  </pre></div>

<h4>
<a id="pytableservice" class="anchor" href="#pytableservice" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>pytable.service</h4>

<p>To start the python code when the Raspberry Pi starts, add the pytable.service file to /lib/systemd/system </p>

<p>Update permissions for the file:</p>

<pre><code>sudo chmod 644 /lib/systemd/system/pytable.service
</code></pre>

<p>Configure systemd:</p>

<pre><code>sudo systemctl daemon-reload
sudo systemctl enable pytable.service
</code></pre>

<p>Reboot:</p>

<pre><code>sudo reboot
</code></pre>

<p>Confirm:</p>

<pre><code>sudo systemctl status pytable.sevice
</code></pre>

<h3>
<a id="user-interface" class="anchor" href="#user-interface" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>User Interface</h3>

<p>The only update to the user interface is for the colors assigned to each team.  Figure out the color for team 1 and team 2 and update public/assets/js/game.js with the correct labels. </p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// You will need to know which sensor maps to which team color.</span>
<span class="pl-k">var</span> team1 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Yellow<span class="pl-pds">'</span></span>; <span class="pl-c">//TODO Change to match your Team One color</span>
<span class="pl-k">var</span> team2 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Black<span class="pl-pds">'</span></span>; <span class="pl-c">//TODO Change to match your Team Two color</span></pre></div>

<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>Version two of this code is the collaboration of <a href="https://github.com/slkaczma">Stefania Kaczmarczyk</a> and <a href="https://github.com/odrodrig">Oliver Rodriguez</a> for SXSW 2016. </p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/slkaczma">slkaczma</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
